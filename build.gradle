plugins {
    id('java')
    id('maven-publish')
    id('com.github.johnrengelman.shadow') version('7.1.2')
    id('com.github.breadmoirai.github-release') version('2.4.1')
}

group("$projectGroup")
version("$projectVersion")

repositories {
    mavenCentral()
}

dependencies {
    implementation("org.mongodb:mongodb-driver-sync:$mongoDriverVersion")
    testImplementation("org.mongodb:mongodb-driver-sync:$mongoDriverVersion")

    // Lombok
    compileOnly("org.projectlombok:lombok:$lombokVersion")
    annotationProcessor("org.projectlombok:lombok:$lombokVersion")

    testCompileOnly("org.projectlombok:lombok:$lombokVersion")
    testAnnotationProcessor("org.projectlombok:lombok:$lombokVersion")

    // Jupiter test dependencies
    testImplementation("org.junit.jupiter:junit-jupiter-engine:$jupiterVersion")
    testImplementation("org.slf4j:slf4j-simple:$slf4jVersion")
}

test {
    useJUnitPlatform()
}

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

tasks.withType(JavaCompile).configureEach {
    options.fork = true
    options.encoding = 'UTF-8'
}

publishing {
    repositories {
        maven {
            url('https://reposilite.koboo.eu/releases')
            credentials {
                username(System.getenv('REPO_USER'))
                password(System.getenv('REPO_TOKEN'))
            }
        }
    }
    publications {
        maven(MavenPublication) {
            from components.java
        }
    }
}

githubRelease {
    token System.getenv('GITHUB_TOKEN')
    generateReleaseNotes = true
    draft = true

    releaseAssets jar.destinationDir.listFiles()
}

task alljavadoc(type: Javadoc) {
    source subprojects.collect { it.sourceSets.main.allJava }
    classpath = files(subprojects.collect { it.sourceSets.main.compileClasspath })
    destinationDir = file("${buildDir}/docs/javadoc")
}

task javadocJar(type: Jar, dependsOn: alljavadoc) {
    classifier = 'javadoc'
    from alljavadoc.destinationDir
}

task sourcesJar(type: Jar) {
    classifier = 'sources'
    from subprojects.collect { it.sourceSets.main.allSource }
}

project.tasks.shadowJar.finalizedBy project.tasks.javadocJar
project.tasks.shadowJar.finalizedBy project.tasks.sourcesJar

project.tasks.build.dependsOn(project.tasks.clean)
project.tasks.githubRelease.dependsOn(project.tasks.shadowJar)